apiVersion: v1
kind: Pod
metadata:
  name: dnsendpoint-job
spec:
  containers:
    - name: apply-dns
      image: bitnami/kubectl
      command:
        - /bin/sh
        - -c
        - |
          echo "Generating DNSEndpoint"
          cat <<EOF | kubectl apply -n network -f -
          apiVersion: externaldns.k8s.io/v1alpha1
          kind: DNSEndpoint
          metadata:
            name: cloudflare-tunnel-endpoint
          spec:
            endpoints:
              - dnsName: "external.${DOMAIN_NAME}"
                recordType: CNAME
                targets:
                  - "${TUNNEL_ID}.cfargotunnel.com"
          EOF
      envFrom:
        - secretRef:
            name: cloudflare-tunnel-configmap
  restartPolicy: Never
